{% load static %}
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title> Holdem </title>
    {%block style%}
    <link rel="stylesheet" type="text/css" href="/static/css/game.css?{% now 'U' %}">
    <link rel="icon" href="/static/favicon.ico">
    {%endblock style%}
</head>
<body>
    <header>
        Hi {{player}}!
        Your Balance: {{balance}}$
    </header>
    <div id="game-table">
        <div class="table-sits-top">
            <div id="player-1">
                
                <button class="sit"> sit 1</button>
                <div>
                    <span class="has-folded"></span>
                    <span class="player-name"> </span>
                    <span class="chips"></span> <br>
                    <img class=card1 src="" alt="" width="60"> 
                    <img class="card2" src="" alt="" width="60"/>
                </div>
                <p class="last-move"></p>
                
            </div>
            
            <div id="player-2">
                <button class="sit">sit 2</button>
                <div>
                    <span class="has-folded"></span>
                    <span class="player-name"> </span>  
                    <span class="chips"></span> <br>
                    <img class=card1 src="" alt="" width="60"> 
                    <img class="card2" src="" alt="" width="60"/>
                </div>
                <p class="last-move"></p>
                
            </div>

            <div id="player-3">
                <button class="sit">sit 3</button>
                <div>
                    <span class="has-folded"></span>
                    <span class="player-name"> </span>  
                    <span class="chips"></span> <br>
                    <img class=card1 src="" alt="" width="60"> 
                    <img class="card2" src="" alt="" width="60"/>
                </div>
                <p class="last-move"></p>
                
            </div>

            <div id="player-4">
                <button class="sit">sit 4</button>
                <div>
                    <span class="has-folded"></span>
                    <span class="player-name"> </span>  
                    <span class="chips"></span> <br>
                    <img class=card1 src="" alt="" width="60"> 
                    <img class="card2" src="" alt="" width="60"/>
                </div>
                <p class="last-move"></p>
                
            </div>
        </div>

        <div id="table-center">
            <div id="log"> Loading Game... </div>
            <div id="game-messages"> </div>
            <div class="messages">
                <div id="pots"></div>
                <div id="turn"></div>
                <div id="table_state"></div>
            </div>

            <div id="community_cards"></div>
        </div>
        
        <div class="table-sits-bottom">
            <div id="player-5">
                <p class="last-move"></p>
                
                <button class="sit"> sit 5</button>
                <div>
                    <span class="has-folded"></span>
                    <span class="player-name"> </span>
                    <span class="chips"></span> <br>
                    <img class=card1 src="" alt="" width="60"> 
                    <img class="card2" src="" alt="" width="60"/>
                </div>
            </div>

            <div id="player-6">
                <p class="last-move"></p>
                <button class="sit"> sit 6</button>
                <div>
                    <span class="has-folded"></span>
                    <span class="player-name"> </span>
                    <span class="chips"></span> <br>
                    <img class=card1 src="" alt="" width="60"> 
                    <img class="card2" src="" alt="" width="60"/>
                </div>
            </div>

            <div id="player-7">
                <p class="last-move"></p>
                
                <button class="sit"> sit 7</button>
                <div>
                    <span class="has-folded"></span>
                    <span class="player-name"> </span>
                    <span class="chips"></span> <br>
                    <img class=card1 src="" alt="" width="60"> 
                    <img class="card2" src="" alt="" width="60"/>
                </div>
            </div>

            <div id="player-8">
                <p class="last-move"></p>
                
                <button class="sit"> sit 8</button>
                <div>
                    <span class="has-folded"></span>
                    <span class="player-name"> </span>
                    <span class="chips"></span> <br>
                    <img class=card1 src="" alt="" width="60"> 
                    <img class="card2" src="" alt="" width="60"/>
                </div>
            </div>

            <div id="player-9">
                <p class="last-move"></p>
                
                <button class="sit"> sit 9</button>
                <div>
                    <span class="has-folded"></span>
                    <span class="player-name"> </span>
                    <span class="chips"></span> <br>
                    <img class=card1 src="" alt="" width="60"> 
                    <img class="card2" src="" alt="" width="60"/>
                </div>
            </div>
        </div>
    </div>

    
    <footer>
        <div id="game-controls">
            <button type="button" value="fold" id="fold"> Fold </button>
            <button type="button" value="call" id="call"> Call </button>
            <button type="button" value="check" id="check"> Check </button>
            <button type="button" value="start_round" id="start_round"> Start Round</button>
            
            <div id="raise">
                <input type="number">
                <button type="submit"> raise</button>
            </div>
        </div>
    </footer>
    <div>
    {{ sits|json_script:"sits" }}
    {{ table_name|json_script:"table-name" }}
    {{ player.username|json_script:"user" }}
    {% if player == p1 %}
    {{ 1|json_script:"sit-number" }}
    {% endif %}
    {% if player == p2 %}
    {{ 2|json_script:"sit-number" }}
    {% endif %}
    </div>

    <script>
        const tableName = JSON.parse(document.getElementById('table-name').textContent);
        /*const sitNumber = JSON.parse(document.getElementById('sit-number').textContent);*/
        const playerName = JSON.parse(document.getElementById('user').textContent);

        const gameSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/game/'
            + tableName
            +'/'
        );
        
        // recieving messages over websocket
        gameSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log(data);
            switch (data.type){
                // might be a good idea to put different cases in seperate functions and call them. -Like was done in table_state.
                case 'table_state':
                    update_table(data);
                    // Recreate table
                    break;

                default:
                    break;
            }
        };

        function update_table(data){
            //document.querySelector('#community_cards').innerText = 'shared cards:' + (data.message.community_cards);
            document.getElementById('community_cards').innerHTML='';
            data.message.community_cards.forEach(card => {
                let cardImage = document.createElement('img');
                cardImage.src = '/static/cards/'+card+'.png';
                cardImage.width = 60;
                cardImage.height = 87;
                cardImage.alt = card;
                cardImage.setAttribute("class", "community-card");
                document.getElementById('community_cards').appendChild(cardImage);

            });
            document.querySelector('#log').innerText = '';

            for (let sit = 1; sit < 10; sit++) {
                    document.querySelector('#player-' + sit + ' .player-name').innerText = '';
                    document.querySelector('#player-' + sit + ' .chips').innerText = '';
                    document.querySelector('#player-' + sit + ' .card1').src = '';
                    document.querySelector('#player-' + sit + ' .card2').src = '';
                    document.querySelector('#player-' + sit + ' .card1').alt = '';
                    document.querySelector('#player-' + sit + ' .card2').alt = '';
                    document.querySelector('#player-' + sit + ' .has-folded').innerText = '';
                }
            
            
            Object.keys(data.message.players).forEach(sit => {
                document.querySelector('#player-' + sit + ' .player-name').innerText = (data.message.players[sit]['username']);
                document.querySelector('#player-' + sit + ' .chips').innerText = (data.message.players[sit]['chips']);
                document.querySelector('#player-' + sit + ' .card1').src = '/static/cards/x.png';
                document.querySelector('#player-' + sit + ' .card2').src = '/static/cards/x.png';
                document.querySelector('#player-' + sit + ' .card1').alt = 'x';
                document.querySelector('#player-' + sit + ' .card2').alt = 'x';
                document.querySelector('#player-' + sit + ' .last-move').innerText = '';
                if (data.message.has_folded[sit]) {
                    document.querySelector('#player-' + sit + ' .has-folded').innerText = 'folded';
                }
                
            });

            Object.keys(data.message.last_moves).forEach(sit => {
                document.querySelector('#player-' + sit + ' .last-move').innerText = data.message.last_moves[sit];
            })

            document.querySelector(('#player-'+data.message.sit+' .card1')).src = '/static/cards/'+data.message.card[0]+'.png';
            document.querySelector(('#player-'+data.message.sit+' .card2')).src = '/static/cards/'+data.message.card[1]+'.png';
            document.querySelector('#player-' + data.message.sit + ' .card1').alt = data.message.card[0];
            document.querySelector('#player-' + data.message.sit + ' .card2').alt = data.message.card[1];

            document.querySelector('#table_state').innerText = 'stage: ' + (data.message.table_state);
            document.querySelector('#turn').innerText = 'Turn: ' + (data.message.turn);

            let pot_keys = Object.keys(data.message.pots);
            let pots = new Array()
            console.log(pot_keys);
            pot_keys.forEach(key => {
                pots.push(data.message.pots[key]['pot']);
            });
            document.querySelector('#pots').innerText = 'Pots: ' + pots.join(" ");
            
            Object.keys(data.message.show_cards).forEach(sit => {
                console.log(data.message.show_cards[sit]);
                document.querySelector(('#player-'+ sit +' .card1')).src = '/static/cards/'+data.message.show_cards[sit][0]+'.png';
                document.querySelector(('#player-'+ sit +' .card2')).src = '/static/cards/'+data.message.show_cards[sit][1]+'.png';
            });

            document.querySelector('#game-messages').innerHTML = '';
            if (data.message.table_state == 0) {
                console.log('game ended');
                Object.keys(data.message.winners).forEach(winner => {
                    console.log(winner);
                    var w = document.createElement('p');
                    w.innerText = (winner + ' wins ' + data.message.winners[winner]);
                    document.querySelector('#game-messages').appendChild(w);
                });
            }
            

        };
        
        gameSocket.onclose = function(e) {
            // const data = JSON.parse(e.data);
            console.error('Chat socket closed unexpectedly');
        };

        // Sending requests over websocket

        

        const raiseRequestDom = document.querySelector('#raise button');
        raiseRequestDom.onclick = function() {
            const amount = document.querySelector('#raise input').value;
            console.log(amount);
            gameSocket.send(JSON.stringify({
                'type':'game_request',
                'message':{
                    'action':'raise',
                    'amount':amount,
                }
            }));
        }

        const foldRequestDom = document.querySelector('#fold');
        foldRequestDom.onclick = function() {
            gameSocket.send(JSON.stringify({
                'type':'game_request',
                'message':{
                    'action':'fold'
                }
            }));
        }

        const callRequestDom = document.querySelector('#call');
        callRequestDom.onclick = function() {
            gameSocket.send(JSON.stringify({
                'type':'game_request',
                'message':{
                    'action':'call'
                }
            }));
        }

        const startRoundRequestDom = document.querySelector('#start_round');
        startRoundRequestDom.onclick = function() {
            gameSocket.send(JSON.stringify({
                'type':'start_hand_request',
                'message':{
                    'action':'start_hand'
                }
            }));
        }
        
        const checkRequestDom = document.querySelector('#check');
        checkRequestDom.onclick = function() {
            gameSocket.send(JSON.stringify({
                'type':'game_request',
                'message':{
                    'action':'check'
                }
            }));
        }

        // requests to sit at table or leave table

        for (let sit = 1; sit < 10; sit++) {
            let sitButton = document.querySelector('#player-' + sit + ' .sit');
            sitButton.onclick = function() {
                gameSocket.send(JSON.stringify({
                    'type':'sit_request',
                    'player':playerName,
                    'sit':sit,
                    'amount':110,
                }));
            };
        };

    </script>
    
</body>
</html>