
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8"/>
    <title> Guessing Game </title>
</head>
<body>
    <div id="player1">
        <button id="sit1"> sit 1</button>
        <div> player:<p id="p1"> </p>   card: <p id="player1-card"></p><div>
    </div>
    <br>
    <br>
    <br>
    <h2 id="log"> Game beggins </h2>
    <br>
    <br>
    <br>

    <div id="player2">
        <button id="sit2"> sit 2</button>
        <div>player: <p id="p2"></p>  card: <p id="player2-card"></p></div>
    </div>
    <br>
    <h2> you:  {{ player }} </h2>

    <form id="select-card" action="">
        <fieldset>
            <legend>Select a card or resign:</legend>
            
            <div>
                <input type="radio" id="1" name="choice" value="1"
                checked>
                <label for="1">1</label>
            </div>
            
            <div>
                <input type="radio" id="2" name="choice" value="2">
                <label for="2">2</label>
            </div>

            <div>
                <button type="submit"> Submit </button>
            </div>
        </fieldset>
    </form>

    <button type="button" value="resign" id="resign"> Resign </button>


    {{ table_name|json_script:"table-name" }}
    {{ player.username|json_script:"player-name" }}
    {% if player == p1 %}
    {{ 1|json_script:"sit-number" }}
    {% endif %}
    {% if player == p2 %}
    {{ 2|json_script:"sit-number" }}
    {% endif %}

    <script>
        const tableName = JSON.parse(document.getElementById('table-name').textContent);
        /*const sitNumber = JSON.parse(document.getElementById('sit-number').textContent);*/
        const playerName = JSON.parse(document.getElementById('player-name').textContent);
        const gameSocket = new WebSocket(
            'ws://'
            + window.location.host
            + '/ws/game/'
            + tableName
            +'/'
        );
        
        // recieving messages over websocket
        gameSocket.onmessage = function(e) {
            const data = JSON.parse(e.data);
            console.log(data);
            switch (data.type){
                // might be a good idea to put different cases in seperate functions and call them.
                /*
                case 'new_move':
                    document.querySelector('#log').innerText = (data.message);
                    break;
                case 'resign':
                    document.querySelector('#log').innerText = (data.message);
                    break;
                */

                case 'table_state':
                    update_table(data);
                    // Recreate table
                    break;

                default:
                    break;
            }
        };

        function update_table(data){
            document.querySelector('#log').innerText = 'winner:' + (data.message.winner);
            document.querySelector('#p1').innerText = (data.message.players['1']);
            document.querySelector('#p2').innerText = (data.message.players['2']);
        }

        gameSocket.onclose = function(e) {
            const data = JSON.parse(e.data);
            document.querySelector('#player'+sitNumber).innerText = 'disconnected';
            console.error('Chat socket closed unexpectedly');
        };

        // Sending messages over websocket
        var moveChoicesDom = document.querySelector('#select-card');
        moveChoicesDom.onsubmit = function(e) {
            
            
            const formData = new FormData(moveChoicesDom);
            console.log(formData);
            
            const data = JSON.stringify(Object.fromEntries(formData));
            const cardChoice = JSON.parse(data).choice;

            gameSocket.send(JSON.stringify({
                'type':'card_choice',
                'choice': cardChoice,
                'player': playerName,
            }));
            e.preventDefault();
        };

        var sitButton1 = document.querySelector('#sit1');
        sitButton1.onclick = function() {
            gameSocket.send(JSON.stringify({
                'type':'sit_request',
                'player':playerName,
                'sit':1
            }));

        };

        var sitButton2 = document.querySelector('#sit2');
        sitButton2.onclick = function() {
            gameSocket.send(JSON.stringify({
                'type':'sit_request',
                'player':playerName,
                'sit':2
            }));

        };

        function render_table_state(table_state) {

        };

    </script>
    
</body>
</html>